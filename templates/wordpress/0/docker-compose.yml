version: '2'

services:

  wordpress:
    image: ohmydocker/docker-wordpress-wp-cli
    labels:
      io.rancher.sidekicks: db,wordpress-datavolume
      io.rancher.container.pull_image: always
    environment:
        - WORDPRESS_DB_USER=${WORDPRESS_DB_USER}
        - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD}
        - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME}
        - WORDPRESS_DB_HOST=${WORDPRESS_DB_HOST}
        - WORDPRESS_BASE_URL=${WORDPRESS_BASE_URL}
        - WORDPRESS_PORT=${WORDPRESS_PORT}
    ports:
      - ${WORDPRESS_PORT}:80
    links:
      - db
    volumes_from:
      - wordpress-datavolume
    restart: always

  db:
    restart: always
    image: mariadb
    volumes_from:
    - wordpress-datavolume
    labels:
      io.rancher.sidekicks: wordpress-datavolume
    environment:
    - MYSQL_USER=${WORDPRESS_DB_USER}
    - MYSQL_PASSWORD=${WORDPRESS_DB_PASSWORD}
    - MYSQL_ROOT_PASSWORD=${WORDPRESS_DB_PASSWORD}
    - MYSQL_DATABASE=${WORDPRESS_DB_NAME}
    - SKIP_NAME_RESOLVE=Yes

  wordpress-datavolume:
    image: "busybox"
    volume_driver: ${VOLUME_DRIVER}
    volumes:
      - ${VOLUME_NAME}:/var/www/html
      - ${DB_VOLUME_NAME}:/var/lib/mysql
    labels:
      io.rancher.container.start_once: true
    entrypoint: ["/bin/true"]
